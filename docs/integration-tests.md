# Интеграционные тесты

Этот документ содержит информацию о фреймворке интеграционного тестирования, используемом в этом проекте.

## Обзор

Интеграционные тесты предназначены для проверки сквозной функциональности Gemini CLI. Они выполняют собранный бинарный файл в контролируемой среде и проверяют, что он ведет себя так, как ожидается, при взаимодействии с файловой системой.

Эти тесты расположены в каталоге `integration-tests` и запускаются с использованием пользовательского тестового запускатора.

## Запуск тестов

Интеграционные тесты не запускаются как часть команды `npm run test` по умолчанию. Они должны быть запущены явно с использованием скрипта `npm run test:integration:all`.

Интеграционные тесты также могут быть запущены с использованием следующего сокращения:

```bash
npm run test:e2e
```

## Запуск определенного набора тестов

Чтобы запустить подмножество тестовых файлов, вы можете использовать `npm run <команда интеграционного теста> <имя_файла1> ....`, где <команда интеграционного теста> — это либо `test:e2e`, либо `test:integration*`, а `<имя_файла>` — любой из файлов `.test.js` в каталоге `integration-tests/`. Например, следующая команда запускает `list_directory.test.js` и `write_file.test.js`:

```bash
npm run test:e2e list_directory write_file
```

### Запуск одного теста по имени

Чтобы запустить один тест по его имени, используйте флаг `--test-name-pattern`:

```bash
npm run test:e2e -- --test-name-pattern "reads a file"
```

### Запуск всех тестов

Чтобы запустить весь набор интеграционных тестов, используйте следующую команду:

```bash
npm run test:integration:all
```

### Матрица песочницы

Команда `all` запустит тесты для `без песочницы`, `docker` и `podman`.
Каждый отдельный тип может быть запущен с использованием следующих команд:

```bash
npm run test:integration:sandbox:none
```

```bash
npm run test:integration:sandbox:docker
```

```bash
npm run test:integration:sandbox:podman
```

## Диагностика

Запускатор интеграционных тестов предоставляет несколько опций для диагностики, чтобы помочь отслеживать сбои тестов.

### Сохранение вывода теста

Вы можете сохранить временные файлы, созданные во время выполнения теста, для проверки. Это полезно для отладки проблем с операциями файловой системы.

Чтобы сохранить вывод теста, вы можете использовать флаг `--keep-output` или установить переменную среды `KEEP_OUTPUT` в `true`.

```bash
# Использование флага
npm run test:integration:sandbox:none -- --keep-output

# Использование переменной среды
KEEP_OUTPUT=true npm run test:integration:sandbox:none
```

Когда вывод сохраняется, запускатор тестов выводит путь к уникальному каталогу для выполнения теста.

### Подробный вывод

Для более подробной отладки флаг `--verbose` передает вывод команды `gemini` в реальном времени в консоль.

```bash
npm run test:integration:sandbox:none -- --verbose
```

При использовании `--verbose` и `--keep-output` в одной команде вывод передается в консоль и также сохраняется в файл журнала во временном каталоге теста.

Подробный вывод форматируется для четкой идентификации источника журналов:

```
--- TEST: <имя-файла-без-js>:<имя-теста> ---
... вывод команды gemini ...
--- END TEST: <имя-файла-без-js>:<имя-теста> ---
```

## Линтинг и форматирование

Для обеспечения качества и согласованности кода файлы интеграционных тестов проверяются линтером как часть основного процесса сборки. Вы также можете вручную запустить линтер и автоисправление.

### Запуск линтера

Чтобы проверить наличие ошибок линтинга, выполните следующую команду:

```bash
npm run lint
```

Вы можете включить флаг `--fix` в команду, чтобы автоматически исправить любые исправляемые ошибки линтинга:

```bash
npm run lint --fix
```

## Структура каталогов

Интеграционные тесты создают уникальный каталог для каждого запуска теста внутри каталога `.integration-tests`. В этом каталоге создается подкаталог для каждого тестового файла, а внутри него создается подкаталог для каждого отдельного тестового случая.

Эта структура позволяет легко найти артефакты для конкретного запуска теста, файла или случая.

```
.integration-tests/
└── <идентификатор-запуска>/
    └── <имя-тестового-файла>.test.js/
        └── <имя-тестового-случая>/
            ├── output.log
            └── ...другие артефакты теста...
```

## Непрерывная интеграция

Для обеспечения постоянного запуска интеграционных тестов рабочий процесс GitHub Actions определен в `.github/workflows/e2e.yml`. Этот рабочий процесс автоматически запускает интеграционные тесты для запросов на вытягивание в ветку `main` или когда запрос на вытягивание добавляется в очередь слияния.

Рабочий процесс запускает тесты в различных средах песочницы, чтобы убедиться, что Gemini CLI протестирован в каждой из них:

- `sandbox:none`: Запускает тесты без какой-либо песочницы.
- `sandbox:docker`: Запускает тесты в контейнере Docker.
- `sandbox:podman`: Запускает тесты в контейнере Podman.
