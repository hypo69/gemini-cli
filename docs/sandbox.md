# Песочница в Gemini CLI

Этот документ содержит руководство по использованию песочницы в Gemini CLI, включая предварительные требования, краткое руководство и конфигурацию.

## Предварительные требования

Перед использованием песочницы необходимо установить и настроить Gemini CLI:

```bash
npm install -g @google/gemini-cli
```

Для проверки установки

```bash
gemini --version
```

## Обзор песочницы

Песочница изолирует потенциально опасные операции (такие как команды оболочки или изменения файлов) от вашей хост-системы, обеспечивая барьер безопасности между операциями ИИ и вашей средой.

Преимущества песочницы включают:

- **Безопасность**: Предотвращение случайного повреждения системы или потери данных.
- **Изоляция**: Ограничение доступа к файловой системе только каталогом проекта.
- **Согласованность**: Обеспечение воспроизводимых сред в разных системах.
- **Безопасность**: Снижение риска при работе с недоверенным кодом или экспериментальными командами.

## Методы песочницы

Идеальный метод песочницы может отличаться в зависимости от вашей платформы и предпочтительного решения для контейнеров.

### 1. macOS Seatbelt (только macOS)

Легкая, встроенная песочница с использованием `sandbox-exec`.

**Профиль по умолчанию**: `permissive-open` - ограничивает запись за пределами каталога проекта, но разрешает большинство других операций.

### 2. На основе контейнеров (Docker/Podman)

Кроссплатформенная песочница с полной изоляцией процессов.

**Примечание**: Требуется сборка образа песочницы локально или использование опубликованного образа из реестра вашей организации.

## Краткое руководство

```bash
# Включить песочницу с флагом команды
gemini -s -p "проанализировать структуру кода"

# Использовать переменную среды
export GEMINI_SANDBOX=true
gemini -p "запустить набор тестов"

# Настроить в settings.json
{
  "sandbox": "docker"
}
```

## Конфигурация

### Включить песочницу (в порядке приоритета)

1. **Флаг команды**: `-s` или `--sandbox`
2. **Переменная среды**: `GEMINI_SANDBOX=true|docker|podman|sandbox-exec`
3. **Файл настроек**: `"sandbox": true` в `settings.json`

### Профили macOS Seatbelt

Встроенные профили (устанавливаются через переменную среды `SEATBELT_PROFILE`):

- `permissive-open` (по умолчанию): Ограничения записи, сеть разрешена
- `permissive-closed`: Ограничения записи, сеть запрещена
- `permissive-proxied`: Ограничения записи, сеть через прокси
- `restrictive-open`: Строгие ограничения, сеть разрешена
- `restrictive-closed`: Максимальные ограничения

### Пользовательские флаги песочницы

Для песочницы на основе контейнеров вы можете внедрять пользовательские флаги в команду `docker` или `podman` с помощью переменной среды `SANDBOX_FLAGS`. Это полезно для расширенных конфигураций, таких как отключение функций безопасности для конкретных случаев использования.

**Пример (Podman)**:

Чтобы отключить метки SELinux для монтирования томов, вы можете установить следующее:

```bash
export SANDBOX_FLAGS="--security-opt label=disable"
```

Несколько флагов могут быть предоставлены в виде строки, разделенной пробелами:

```bash
export SANDBOX_FLAGS="--flag1 --flag2=value"
```

## Обработка UID/GID в Linux

Песочница автоматически обрабатывает разрешения пользователей в Linux. Переопределите эти разрешения с помощью:

```bash
export SANDBOX_SET_UID_GID=true   # Принудительно использовать UID/GID хоста
export SANDBOX_SET_UID_GID=false  # Отключить сопоставление UID/GID
```

## Устранение неполадок

### Распространенные проблемы

**"Операция не разрешена"**

- Операция требует доступа за пределами песочницы.
- Попробуйте более разрешительный профиль или добавьте точки монтирования.

**Отсутствующие команды**

- Добавьте в пользовательский Dockerfile.
- Установите через `sandbox.bashrc`.

**Проблемы с сетью**

- Проверьте, разрешает ли профиль песочницы сеть.
- Проверьте конфигурацию прокси.

### Режим отладки

```bash
DEBUG=1 gemini -s -p "команда отладки"
```

### Проверка песочницы

```bash
# Проверить среду
gemini -s -p "выполнить команду оболочки: env | grep SANDBOX"

# Список монтирований
gemini -s -p "выполнить команду оболочки: mount | grep workspace"
```

## Заметки по безопасности

- Песочница снижает, но не устраняет все риски.
- Используйте наиболее строгий профиль, который позволяет выполнять вашу работу.
- Накладные расходы контейнера минимальны после первой сборки.
- Графические приложения могут не работать в песочницах.

## Связанная документация

- [Конфигурация](./cli/configuration.md): Полные параметры конфигурации.
- [Команды](./cli/commands.md): Доступные команды.
- [Устранение неполадок](./troubleshooting.md): Общее устранение неполадок.
